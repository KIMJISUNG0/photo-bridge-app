<script src="https://cdn.socket.io/4.0.0/socket.io.min.js"></script>
<script>
  const socket = io();
  const peer = new RTCPeerConnection();
  let channel;
  let roomId = prompt("ê°™ì€ ë°© IDë¥¼ ì…ë ¥í•˜ì„¸ìš” (ì˜ˆ: test123)");

  // ë°© ì°¸ì—¬
  socket.emit('join', roomId);

  // ë°ì´í„° ì±„ë„ ìƒì„± (ì†¡ì‹ ì)
  channel = peer.createDataChannel('file');
  channel.onopen = () => {
    console.log("ğŸ“¡ DataChannel ì—°ê²°ë¨");
    document.querySelector("button").disabled = false; // ì—°ê²° í›„ ì „ì†¡ ë²„íŠ¼ í™œì„±í™”
  };

  // ìˆ˜ì‹ ì
  peer.ondatachannel = event => {
    const receiveChannel = event.channel;
    let receivedChunks = [];
    receiveChannel.onmessage = e => {
      receivedChunks.push(e.data);
      if (e.data.byteLength < 16384) {
        const blob = new Blob(receivedChunks);
        const url = URL.createObjectURL(blob);
        const img = document.createElement('img');
        img.src = url;
        document.getElementById('gallery').appendChild(img);
        receivedChunks = [];
      }
    };
  };

  // ICE í›„ë³´ ì²˜ë¦¬
  peer.onicecandidate = e => {
    if (e.candidate) socket.emit('candidate', { roomId, candidate: e.candidate });
  };

  // ì‹œê·¸ë„ë§ ì²˜ë¦¬
  socket.on('ready', async () => {
    const offer = await peer.createOffer();
    await peer.setLocalDescription(offer);
    socket.emit('offer', { roomId, offer });
  });

  socket.on('offer', async offer => {
    await peer.setRemoteDescription(new RTCSessionDescription(offer));
    const answer = await peer.createAnswer();
    await peer.setLocalDescription(answer);
    socket.emit('answer', { roomId, answer });
  });

  socket.on('answer', async answer => {
    await peer.setRemoteDescription(new RTCSessionDescription(answer));
  });

  socket.on('candidate', candidate => {
    peer.addIceCandidate(new RTCIceCandidate(candidate));
  });

  // íŒŒì¼ ì „ì†¡
  async function sendFile() {
    const file = document.getElementById('fileInput').files[0];
    if (!file) return alert("íŒŒì¼ì„ ì„ íƒí•˜ì„¸ìš”!");
    const arrayBuffer = await file.arrayBuffer();
    const chunkSize = 16384;
    let offset = 0;
    while (offset < arrayBuffer.byteLength) {
      const chunk = arrayBuffer.slice(offset, offset + chunkSize);
      channel.send(chunk);
      offset += chunkSize;
      await new Promise(r => setTimeout(r, 10));
    }
    channel.send(new Uint8Array(0)); // ì „ì†¡ ì™„ë£Œ í‘œì‹œ
  }
</script>
