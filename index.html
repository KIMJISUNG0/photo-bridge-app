<script src="https://cdn.socket.io/4.0.0/socket.io.min.js"></script>
<script>
  const socket = io();
  const peer = new RTCPeerConnection();
  let channel;
  let roomId = prompt("같은 방 ID를 입력하세요 (예: test123)");

  // 방 참여
  socket.emit('join', roomId);

  // 데이터 채널 생성 (송신자)
  channel = peer.createDataChannel('file');
  channel.onopen = () => {
    console.log("📡 DataChannel 연결됨");
    document.querySelector("button").disabled = false; // 연결 후 전송 버튼 활성화
  };

  // 수신자
  peer.ondatachannel = event => {
    const receiveChannel = event.channel;
    let receivedChunks = [];
    receiveChannel.onmessage = e => {
      receivedChunks.push(e.data);
      if (e.data.byteLength < 16384) {
        const blob = new Blob(receivedChunks);
        const url = URL.createObjectURL(blob);
        const img = document.createElement('img');
        img.src = url;
        document.getElementById('gallery').appendChild(img);
        receivedChunks = [];
      }
    };
  };

  // ICE 후보 처리
  peer.onicecandidate = e => {
    if (e.candidate) socket.emit('candidate', { roomId, candidate: e.candidate });
  };

  // 시그널링 처리
  socket.on('ready', async () => {
    const offer = await peer.createOffer();
    await peer.setLocalDescription(offer);
    socket.emit('offer', { roomId, offer });
  });

  socket.on('offer', async offer => {
    await peer.setRemoteDescription(new RTCSessionDescription(offer));
    const answer = await peer.createAnswer();
    await peer.setLocalDescription(answer);
    socket.emit('answer', { roomId, answer });
  });

  socket.on('answer', async answer => {
    await peer.setRemoteDescription(new RTCSessionDescription(answer));
  });

  socket.on('candidate', candidate => {
    peer.addIceCandidate(new RTCIceCandidate(candidate));
  });

  // 파일 전송
  async function sendFile() {
    const file = document.getElementById('fileInput').files[0];
    if (!file) return alert("파일을 선택하세요!");
    const arrayBuffer = await file.arrayBuffer();
    const chunkSize = 16384;
    let offset = 0;
    while (offset < arrayBuffer.byteLength) {
      const chunk = arrayBuffer.slice(offset, offset + chunkSize);
      channel.send(chunk);
      offset += chunkSize;
      await new Promise(r => setTimeout(r, 10));
    }
    channel.send(new Uint8Array(0)); // 전송 완료 표시
  }
</script>
